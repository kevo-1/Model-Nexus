<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Model Nexus - ML Inference Platform</title>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			:root {
				--bg-primary: #0a0e1a;
				--bg-secondary: #111827;
				--bg-card: #1a1f35;
				--bg-card-hover: #222844;
				--accent-primary: #00d9ff;
				--accent-secondary: #7c3aed;
				--accent-gradient: linear-gradient(135deg, #00d9ff 0%, #7c3aed 100%);
				--text-primary: #ffffff;
				--text-secondary: #94a3b8;
				--text-muted: #64748b;
				--border-color: #2d3548;
				--success: #10b981;
				--error: #ef4444;
				--warning: #f59e0b;
			}

			body {
				font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
				background: var(--bg-primary);
				color: var(--text-primary);
				line-height: 1.6;
				overflow-x: hidden;
			}

			/* Animated background */
			.bg-gradient {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: 0;
				opacity: 0.08;
				background: 
					radial-gradient(circle at 20% 50%, rgba(0, 217, 255, 0.15) 0%, transparent 50%),
					radial-gradient(circle at 80% 80%, rgba(124, 58, 237, 0.15) 0%, transparent 50%);
			}

			.container {
				position: relative;
				z-index: 1;
				max-width: 1400px;
				margin: 0 auto;
				padding: 2rem;
			}

			/* Header */
			header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 3rem;
				padding: 1.5rem 2rem;
				background: var(--bg-card);
				border: 1px solid var(--border-color);
				border-radius: 16px;
				backdrop-filter: blur(10px);
				animation: slideDown 0.6s ease;
			}

			@keyframes slideDown {
				from {
					opacity: 0;
					transform: translateY(-20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.logo-section {
				display: flex;
				align-items: center;
				gap: 1rem;
			}

			.logo {
				width: 10px;
				height: 10px;
				background: var(--accent-gradient);
				border-radius: 50%;
			}

			h1 {
				font-size: 1.75rem;
				font-weight: 800;
				background: var(--accent-gradient);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.subtitle {
				font-size: 0.875rem;
				color: var(--text-secondary);
				font-weight: 500;
				margin-top: 0.25rem;
			}

			/* Status Badge */
			.status-section {
				display: flex;
				align-items: center;
				gap: 1rem;
			}

			.status-badge {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				padding: 0.625rem 1.25rem;
				border-radius: 50px;
				font-size: 0.875rem;
				font-weight: 600;
				background: var(--bg-secondary);
				border: 1px solid var(--border-color);
				transition: all 0.3s ease;
			}

			.status-dot {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				background: var(--text-muted);
			}

			.status-badge.online .status-dot {
				background: var(--success);
			}

			.status-badge.offline .status-dot {
				background: var(--error);
			}

			/* Stats Grid */
			.stats-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 1.5rem;
				margin-bottom: 2rem;
				animation: fadeIn 0.6s ease 0.2s both;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.stat-card {
				background: var(--bg-card);
				border: 1px solid var(--border-color);
				border-radius: 12px;
				padding: 1.5rem;
				transition: all 0.3s ease;
			}

			.stat-card:hover {
				border-color: var(--accent-primary);
			}

			.stat-label {
				font-size: 0.75rem;
				color: var(--text-muted);
				text-transform: uppercase;
				letter-spacing: 0.1em;
				font-weight: 600;
				margin-bottom: 0.5rem;
			}

			.stat-value {
				font-size: 2rem;
				font-weight: 800;
				font-family: 'JetBrains Mono', monospace;
				color: var(--text-primary);
			}

			.stat-unit {
				font-size: 0.875rem;
				color: var(--text-secondary);
				margin-left: 0.25rem;
			}

			/* Main Grid */
			.main-grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 2rem;
				animation: fadeIn 0.6s ease 0.4s both;
			}

			@media (max-width: 968px) {
				.main-grid {
					grid-template-columns: 1fr;
				}
			}

			/* Card Styles */
			.card {
				background: var(--bg-card);
				border: 1px solid var(--border-color);
				border-radius: 16px;
				padding: 2rem;
				backdrop-filter: blur(10px);
			}

			.card-header {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				margin-bottom: 1.5rem;
				padding-bottom: 1rem;
				border-bottom: 1px solid var(--border-color);
			}

			.card-icon {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				background: var(--accent-primary);
			}

			h2 {
				font-size: 1.25rem;
				font-weight: 700;
			}

			/* Form Styles */
			.form-group {
				margin-bottom: 1.5rem;
			}

			label {
				display: block;
				font-weight: 600;
				margin-bottom: 0.5rem;
				color: var(--text-secondary);
				font-size: 0.875rem;
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}

			select,
			textarea,
			input {
				width: 100%;
				padding: 0.875rem 1rem;
				background: var(--bg-secondary);
				border: 1px solid var(--border-color);
				border-radius: 10px;
				color: var(--text-primary);
				font-family: 'JetBrains Mono', monospace;
				font-size: 0.875rem;
				transition: all 0.3s ease;
			}

			select:focus,
			textarea:focus,
			input:focus {
				outline: none;
				border-color: var(--accent-primary);
				box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
			}

			textarea {
				min-height: 120px;
				resize: vertical;
			}

			select {
				cursor: pointer;
			}

			/* Button */
			button {
				width: 100%;
				padding: 1rem 1.5rem;
				background: var(--accent-gradient);
				color: var(--text-primary);
				border: none;
				border-radius: 10px;
				font-weight: 700;
				font-size: 1rem;
				cursor: pointer;
				transition: all 0.3s ease;
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}

			button:hover {
				opacity: 0.9;
				transform: translateY(-1px);
			}

			button:active {
				transform: translateY(0);
			}

			button:disabled {
				background: var(--bg-secondary);
				cursor: not-allowed;
				opacity: 0.5;
			}

			button:disabled:hover {
				transform: none;
			}

			.button-content {
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 0.5rem;
			}

			/* Result Area */
			.result-area {
				margin-top: 1.5rem;
				padding: 1.5rem;
				background: var(--bg-secondary);
				border: 1px solid var(--border-color);
				border-radius: 10px;
				font-family: 'JetBrains Mono', monospace;
				font-size: 0.813rem;
				line-height: 1.6;
				display: none;
				animation: slideUp 0.3s ease;
			}

			@keyframes slideUp {
				from {
					opacity: 0;
					transform: translateY(10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.result-area.error {
				border-color: var(--error);
				background: rgba(239, 68, 68, 0.1);
			}

			.result-area.success {
				border-color: var(--success);
				background: rgba(16, 185, 129, 0.1);
			}

			.result-header {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				margin-bottom: 1rem;
				padding-bottom: 0.75rem;
				border-bottom: 1px solid var(--border-color);
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.1em;
				font-size: 0.75rem;
			}

			.result-content {
				white-space: pre-wrap;
				word-break: break-word;
			}

			/* Models List */
			.models-list {
				max-height: 400px;
				overflow-y: auto;
				padding-right: 0.5rem;
			}

			.models-list::-webkit-scrollbar {
				width: 6px;
			}

			.models-list::-webkit-scrollbar-track {
				background: var(--bg-secondary);
				border-radius: 10px;
			}

			.models-list::-webkit-scrollbar-thumb {
				background: var(--border-color);
				border-radius: 10px;
			}

			.models-list::-webkit-scrollbar-thumb:hover {
				background: var(--accent-primary);
			}

			.model-item {
				padding: 1rem;
				background: var(--bg-secondary);
				border: 1px solid var(--border-color);
				border-radius: 10px;
				margin-bottom: 0.75rem;
				transition: all 0.2s ease;
				cursor: pointer;
			}

			.model-item:hover {
				border-color: var(--accent-primary);
			}

			.model-name {
				font-weight: 700;
				font-family: 'JetBrains Mono', monospace;
				color: var(--accent-primary);
				margin-bottom: 0.25rem;
			}

			.model-meta {
				font-size: 0.75rem;
				color: var(--text-muted);
			}

			.empty-state {
				text-align: center;
				padding: 3rem 1rem;
				color: var(--text-muted);
			}

			/* Loading Spinner */
			.spinner {
				width: 16px;
				height: 16px;
				border: 2px solid var(--text-primary);
				border-top-color: transparent;
				border-radius: 50%;
				animation: spin 0.8s linear infinite;
			}

			@keyframes spin {
				to { transform: rotate(360deg); }
			}

			/* Quick Examples */
			.examples {
				margin-top: 1rem;
				padding: 1rem;
				background: var(--bg-secondary);
				border-radius: 10px;
				border: 1px solid var(--border-color);
			}

			.examples-title {
				font-size: 0.75rem;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.1em;
				color: var(--text-muted);
				margin-bottom: 0.75rem;
			}

			.example-chips {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
			}

			.example-chip {
				padding: 0.5rem 0.875rem;
				background: var(--bg-card);
				border: 1px solid var(--border-color);
				border-radius: 20px;
				font-size: 0.75rem;
				font-family: 'JetBrains Mono', monospace;
				color: var(--text-secondary);
				cursor: pointer;
				transition: all 0.2s ease;
			}

			.example-chip:hover {
				border-color: var(--accent-primary);
				color: var(--accent-primary);
			}

			/* Footer */
			footer {
				margin-top: 3rem;
				padding-top: 2rem;
				border-top: 1px solid var(--border-color);
				text-align: center;
				color: var(--text-muted);
				font-size: 0.875rem;
			}

			.footer-links {
				display: flex;
				justify-content: center;
				gap: 2rem;
				margin-top: 1rem;
			}

			.footer-link {
				color: var(--text-secondary);
				text-decoration: none;
				transition: color 0.3s ease;
			}

			.footer-link:hover {
				color: var(--accent-primary);
			}
		</style>
	</head>
	<body>
		<div class="bg-gradient"></div>
		<div class="container">
			<header>
				<div class="logo-section">
					<div class="logo"></div>
					<div>
						<h1>Model Nexus</h1>
						<div class="subtitle">ML Inference Platform</div>
					</div>
				</div>
				<div class="status-section">
					<div id="server-status" class="status-badge">
						<div class="status-dot"></div>
						<span>Checking...</span>
					</div>
				</div>
			</header>

			<!-- Stats Grid -->
			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-label">Models Loaded</div>
					<div class="stat-value" id="stat-models">
						<span class="spinner"></span>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-label">Total Predictions</div>
					<div class="stat-value" id="stat-predictions">
						<span class="spinner"></span>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-label">Avg Latency</div>
					<div class="stat-value" id="stat-latency">
						<span class="spinner"></span>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-label">Success Rate</div>
					<div class="stat-value" id="stat-success">
						<span class="spinner"></span>
					</div>
				</div>
			</div>

			<!-- Main Grid -->
			<div class="main-grid">
				<!-- Prediction Form -->
				<div class="card">
					<div class="card-header">
						<div class="card-icon"></div>
						<h2>Make a Prediction</h2>
					</div>

					<form id="prediction-form">
						<div class="form-group">
							<label for="model-select">Select Model</label>
							<select id="model-select" required>
								<option value="" disabled selected>Loading models...</option>
							</select>
						</div>

						<div class="form-group">
							<label for="input-data">Input Features (JSON Array)</label>
							<textarea
								id="input-data"
								placeholder='[5.1, 3.5, 1.4, 0.2]'
								required
							></textarea>
						</div>

						<div class="examples">
							<div class="examples-title">Quick Examples</div>
							<div class="example-chips">
								<div class="example-chip" data-example='[5.1, 3.5, 1.4, 0.2]'>Setosa</div>
								<div class="example-chip" data-example='[6.5, 3.0, 5.2, 2.0]'>Virginica</div>
								<div class="example-chip" data-example='[5.9, 3.0, 4.2, 1.5]'>Versicolor</div>
							</div>
						</div>

						<button type="submit" id="predict-btn">
							<span class="button-content">
								<span>Run Prediction</span>
							</span>
						</button>
					</form>

					<div id="result-area" class="result-area"></div>
				</div>

				<!-- Models List -->
				<div class="card">
					<div class="card-header">
						<div class="card-icon"></div>
						<h2>Available Models</h2>
					</div>
					<div id="models-list" class="models-list">
						<div class="empty-state">
							<div>Loading models...</div>
						</div>
					</div>
				</div>
			</div>

			<footer>
				<div>Built with Go, ONNX Runtime & Clean Architecture</div>
				<div class="footer-links">
					<a href="https://github.com/kevo-1/model-nexus" class="footer-link" target="_blank">GitHub</a>
					<a href="/metrics" class="footer-link" target="_blank">Metrics</a>
					<a href="/health" class="footer-link" target="_blank">Health Check</a>
				</div>
			</footer>
		</div>

		<script>
			const API_BASE = "https://model-nexus.up.railway.app";

			// Elements
			const statusBadge = document.getElementById("server-status");
			const modelSelect = document.getElementById("model-select");
			const predictionForm = document.getElementById("prediction-form");
			const inputData = document.getElementById("input-data");
			const predictBtn = document.getElementById("predict-btn");
			const resultArea = document.getElementById("result-area");
			const modelsList = document.getElementById("models-list");

			// Stats elements
			const statModels = document.getElementById("stat-models");
			const statPredictions = document.getElementById("stat-predictions");
			const statLatency = document.getElementById("stat-latency");
			const statSuccess = document.getElementById("stat-success");

			// Local state
			let totalPredictions = 0;
			let successfulPredictions = 0;
			let totalLatency = 0;

			// Check Health
			async function checkHealth() {
				try {
					const res = await fetch(`${API_BASE}/health`);
					if (res.ok) {
						statusBadge.querySelector('span').textContent = 'System Online';
						statusBadge.classList.add('online');
						statusBadge.classList.remove('offline');
					} else {
						throw new Error("Health check failed");
					}
				} catch (error) {
					statusBadge.querySelector('span').textContent = 'System Offline';
					statusBadge.classList.add('offline');
					statusBadge.classList.remove('online');
					console.error("Health check error:", error);
				}
			}

			// Fetch Models
			async function fetchModels() {
				try {
					const res = await fetch(`${API_BASE}/models`);
					if (!res.ok) throw new Error("Failed to fetch models");

					const data = await res.json();
					const models = data.models || [];

					// Update stats
					statModels.textContent = models.length;

					// Update select dropdown
					modelSelect.innerHTML = '<option value="" disabled selected>Select a model</option>';
					models.forEach((model) => {
						const option = document.createElement("option");
						option.value = model;
						option.textContent = model;
						modelSelect.appendChild(option);
					});

					// Update models list
					if (models.length === 0) {
						modelsList.innerHTML = `
							<div class="empty-state">
								<div>No models available</div>
							</div>
						`;
					} else {
						modelsList.innerHTML = models.map(model => `
							<div class="model-item" onclick="selectModel('${model}')">
								<div class="model-name">${model}</div>
								<div class="model-meta">Ready for inference</div>
							</div>
						`).join('');
					}
				} catch (error) {
					console.error("Error fetching models:", error);
					modelSelect.innerHTML = '<option value="" disabled>Error loading models</option>';
					modelsList.innerHTML = `
						<div class="empty-state">
							<div>Failed to load models</div>
						</div>
					`;
					statModels.textContent = '0';
				}
			}

			// Select model from list
			window.selectModel = function(modelId) {
				modelSelect.value = modelId;
				modelSelect.dispatchEvent(new Event('change'));
			}

			// Handle Prediction
			predictionForm.addEventListener("submit", async (e) => {
				e.preventDefault();
				const modelName = modelSelect.value;
				const rawInput = inputData.value.trim();

				// Validation errors - don't count toward success rate
				if (!modelName) {
					const errorHTML = `
						<div class="result-header">Validation Error</div>
						<div class="result-content">Please select a model from the dropdown.</div>
					`;
					showResult(errorHTML, true);
					return;
				}

				if (!rawInput) {
					const errorHTML = `
						<div class="result-header">Validation Error</div>
						<div class="result-content">Please enter input features. Example: [5.1, 3.5, 1.4, 0.2]</div>
					`;
					showResult(errorHTML, true);
					return;
				}

				let parsedInput;
				try {
					parsedInput = JSON.parse(rawInput);
				} catch (error) {
					const errorHTML = `
						<div class="result-header">Invalid Format</div>
						<div class="result-content">Please enter a valid list of numbers in square brackets. Example: [5.1, 3.5, 1.4, 0.2]</div>
					`;
					showResult(errorHTML, true);
					return;
				}

				// Check if it's an array
				if (!Array.isArray(parsedInput)) {
					const errorHTML = `
						<div class="result-header">Invalid Format</div>
						<div class="result-content">Input must be a list of numbers in square brackets. Example: [5.1, 3.5, 1.4, 0.2]</div>
					`;
					showResult(errorHTML, true);
					return;
				}

				// Check if all elements are numbers
				if (!parsedInput.every(item => typeof item === 'number' && !isNaN(item))) {
					const errorHTML = `
						<div class="result-header">Invalid Data</div>
						<div class="result-content">All values must be numbers. Example: [5.1, 3.5, 1.4, 0.2]</div>
					`;
					showResult(errorHTML, true);
					return;
				}

				predictBtn.disabled = true;
				predictBtn.innerHTML = `
					<span class="button-content">
						<span class="spinner"></span>
						<span>Running...</span>
					</span>
				`;
				resultArea.style.display = "none";

				const startTime = performance.now();

				try {
					const res = await fetch(`${API_BASE}/predict`, {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({
							model_id: modelName,
							features: parsedInput,
						}),
					});

					const endTime = performance.now();
					const clientLatency = (endTime - startTime).toFixed(2);

					// Try to parse response body
					let data;
					let errorText;
					try {
						data = await res.json();
					} catch (parseError) {
						// If response isn't JSON, get text
						errorText = await res.text();
					}

					if (!res.ok) {
						// Only count as failed prediction if it's a 4xx or 5xx error
						totalPredictions++;
						
						let errorMessage = 'Something went wrong with your request.';

						if (data && data.error) {
							// Make backend errors more user-friendly
							const backendError = data.error.toLowerCase();
							
							if (backendError.includes('expected') && backendError.includes('features')) {
								// Parse "expected 4 features, got 3" type messages
								const match = data.error.match(/expected (\d+) features, got (\d+)/i);
								if (match) {
									errorMessage = `This model needs exactly ${match[1]} input values, but you provided ${match[2]}. Please adjust your input.`;
								} else {
									errorMessage = 'Wrong number of input features. Please check your model requirements.';
								}
							} else if (backendError.includes('invalid input')) {
								errorMessage = 'Invalid input format. Please make sure you\'re providing the correct data for this model.';
							} else if (backendError.includes('model not found')) {
								errorMessage = 'This model is no longer available. Please select a different model from the list.';
							} else {
								// Use backend message if it's already user-friendly
								errorMessage = data.error;
							}
						} else if (errorText) {
							errorMessage = errorText;
						}

						// Add friendly context based on status code
						if (res.status === 404) {
							errorMessage = 'Model not found. Please refresh the page and select a different model.';
						} else if (res.status === 500) {
							errorMessage = 'The model encountered an error. Please try again in a moment.';
						}

						const errorHTML = `
							<div class="result-header">Request Failed</div>
							<div class="result-content">${errorMessage}</div>
						`;
						showResult(errorHTML, true);
					} else {
						// Count as successful prediction
						totalPredictions++;
						successfulPredictions++;
						totalLatency += parseFloat(data.latency_ms || clientLatency);
						
						const resultHTML = `
							<div class="result-header">Prediction Complete</div>
							<div class="result-content">${JSON.stringify(data, null, 2)}</div>
						`;
						showResult(resultHTML, false);
					}

					updateStats();
				} catch (error) {
					// Network error - DON'T count toward success rate
					// This is a connectivity issue, not a prediction failure
					console.error("Prediction error:", error);
					const errorHTML = `
						<div class="result-header">Connection Error</div>
						<div class="result-content">Could not reach the server. Please check your internet connection and try again.</div>
					`;
					showResult(errorHTML, true);
					// Note: NOT incrementing totalPredictions here
				} finally {
					predictBtn.disabled = false;
					predictBtn.innerHTML = `
						<span class="button-content">
							<span>Run Prediction</span>
						</span>
					`;
				}
			});

			// Show result
			function showResult(content, isError) {
				resultArea.innerHTML = content;
				resultArea.style.display = "block";
				resultArea.className = "result-area " + (isError ? "error" : "success");
			}

			// Update stats
			function updateStats() {
				statPredictions.textContent = totalPredictions;
				
				if (totalPredictions > 0) {
					const avgLatency = (totalLatency / successfulPredictions).toFixed(2);
					statLatency.innerHTML = `${avgLatency}<span class="stat-unit">ms</span>`;
					
					const successRate = ((successfulPredictions / totalPredictions) * 100).toFixed(1);
					statSuccess.innerHTML = `${successRate}<span class="stat-unit">%</span>`;
				} else {
					statPredictions.textContent = '0';
					statLatency.innerHTML = '0<span class="stat-unit">ms</span>';
					statSuccess.innerHTML = '0<span class="stat-unit">%</span>';
				}
			}

			// Example chips
			document.querySelectorAll('.example-chip').forEach(chip => {
				chip.addEventListener('click', () => {
					inputData.value = chip.getAttribute('data-example');
				});
			});

			// Initialize
			checkHealth();
			fetchModels();
			updateStats();

			// Refresh models every 30 seconds
			setInterval(fetchModels, 30000);
		</script>
	</body>
</html>